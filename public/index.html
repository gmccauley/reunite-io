<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reunite.IO - Lost & Found Apple Watch</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { display: none; }
        .modal.active { display: flex; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- App Container -->
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <nav class="container mx-auto px-4 lg:px-6 py-4 flex justify-between items-center">
                <a href="#" class="text-2xl font-bold text-indigo-600">Reunite.IO</a>
                <!-- Logged Out State -->
                <div id="logged-out-nav" class="space-x-2">
                    <button onclick="openModal('loginModal')" class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-indigo-600">Log In</button>
                    <button onclick="openModal('registerModal')" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">Register</button>
                </div>
                <!-- Logged In State -->
                <div id="logged-in-nav" class="hidden items-center space-x-4">
                    <span id="user-greeting" class="text-sm font-medium">Welcome, User!</span>
                    <button onclick="openModal('foundModal')" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700">Report Found Watch</button>
                    <button onclick="openModal('lostModal')" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Report Lost Watch</button>
                    <button onclick="logout()" class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-indigo-600">Log Out</button>
                </div>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 lg:px-6 py-8">
            <!-- Hero Section -->
            <section class="text-center my-12">
                <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900">Lost your Apple Watch?</h1>
                <p class="mt-4 max-w-2xl mx-auto text-lg text-gray-600">Our community helps reunite owners with their lost devices. Report a found watch or check if yours has been located.</p>
            </section>

            <!-- Stats Section -->
            <section class="grid grid-cols-1 md:grid-cols-3 gap-6 my-12">
                <div class="bg-white p-6 rounded-lg shadow text-center">
                    <h3 class="text-4xl font-bold text-red-500" id="lost-count">...</h3>
                    <p class="mt-2 text-sm font-medium text-gray-500">Active Lost Reports</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow text-center">
                    <h3 class="text-4xl font-bold text-green-500" id="found-count">...</h3>
                    <p class="mt-2 text-sm font-medium text-gray-500">Found Watches Logged</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow text-center">
                    <h3 class="text-4xl font-bold text-indigo-500" id="reunited-count">...</h3>
                    <p class="mt-2 text-sm font-medium text-gray-500">Successfully Reunited</p>
                </div>
            </section>

            <!-- Map Section -->
            <section class="bg-white p-4 sm:p-6 rounded-lg shadow my-12 relative z-0">
                <h2 class="text-2xl font-bold mb-4 text-center">Lost & Found Hotspots</h2>
                <div id="map" class="h-96 w-full rounded-md"></div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <!-- Login Modal -->
    <div id="loginModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative">
            <button onclick="closeModal('loginModal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">&times;</button>
            <h3 class="text-xl font-semibold mb-4">Log In</h3>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="loginEmail" class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input type="email" id="loginEmail" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="loginPassword" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Log In</button>
            </form>
        </div>
    </div>
    
    <!-- Register Modal -->
    <div id="registerModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative">
            <button onclick="closeModal('registerModal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">&times;</button>
            <h3 class="text-xl font-semibold mb-4">Create Account</h3>
            <form id="registerForm" class="space-y-4">
                <div>
                    <label for="registerName" class="block text-sm font-medium text-gray-700">Full Name</label>
                    <input type="text" id="registerName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="registerEmail" class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input type="email" id="registerEmail" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="registerPassword" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="registerPassword" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Register</button>
            </form>
        </div>
    </div>
    
    <!-- Report Found Watch Modal -->
    <div id="foundModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-50 overflow-y-auto">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 relative my-8">
            <button onclick="closeModal('foundModal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">&times;</button>
            <h3 class="text-xl font-semibold mb-4">Report a Found Apple Watch</h3>
            <form id="foundForm" class="space-y-4">
                <div>
                    <label for="foundSerial" class="block text-sm font-medium text-gray-700">Serial Number</label>
                    <input type="text" id="foundSerial" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Find on the back of the watch">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="foundModel" class="block text-sm font-medium text-gray-700">Model</label>
                        <select id="foundModel" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            <option>Series 9</option>
                            <option>Ultra 2</option>
                            <option>SE</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div>
                        <label for="foundColor" class="block text-sm font-medium text-gray-700">Color</label>
                        <input type="text" id="foundColor" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., Midnight, Starlight">
                    </div>
                </div>
                 <div>
                    <label for="foundAddress" class="block text-sm font-medium text-gray-700">Address / Cross Streets Where Found</label>
                    <input type="text" id="foundAddress" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="123 Main St">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="foundCity" class="block text-sm font-medium text-gray-700">City</label>
                        <input type="text" id="foundCity" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="San Antonio">
                    </div>
                    <div>
                        <label for="foundState" class="block text-sm font-medium text-gray-700">State</label>
                        <input type="text" id="foundState" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="TX">
                    </div>
                    <div>
                        <label for="foundZip" class="block text-sm font-medium text-gray-700">Zip Code</label>
                        <input type="text" id="foundZip" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="78205">
                    </div>
                </div>
                <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">Submit Found Report</button>
            </form>
        </div>
    </div>
    
    <!-- Report Lost Watch Modal -->
    <div id="lostModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-50 overflow-y-auto">
         <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 relative my-8">
            <button onclick="closeModal('lostModal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">&times;</button>
            <h3 class="text-xl font-semibold mb-4">Report a Lost Apple Watch</h3>
            <form id="lostForm" class="space-y-4">
                 <div>
                    <label for="lostSerial" class="block text-sm font-medium text-gray-700">Serial Number</label>
                    <input type="text" id="lostSerial" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Check your Apple ID account or original box">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="lostModel" class="block text-sm font-medium text-gray-700">Model</label>
                         <select id="lostModel" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            <option>Series 9</option>
                            <option>Ultra 2</option>
                            <option>SE</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div>
                        <label for="lostColor" class="block text-sm font-medium text-gray-700">Color</label>
                        <input type="text" id="lostColor" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., Midnight, Starlight">
                    </div>
                </div>
                 <div>
                    <label for="lostAddress" class="block text-sm font-medium text-gray-700">Last Known Address / Area</label>
                    <input type="text" id="lostAddress" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="123 Main St">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="lostCity" class="block text-sm font-medium text-gray-700">City</label>
                        <input type="text" id="lostCity" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="San Antonio">
                    </div>
                    <div>
                        <label for="lostState" class="block text-sm font-medium text-gray-700">State</label>
                        <input type="text" id="lostState" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="TX">
                    </div>
                    <div>
                        <label for="lostZip" class="block text-sm font-medium text-gray-700">Zip Code</label>
                        <input type="text" id="lostZip" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="78205">
                    </div>
                </div>
                <button type="submit" class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700">Submit Lost Report</button>
            </form>
        </div>
    </div>
    
    <script>
        // --- State Management ---
        let isLoggedIn = false;

        // --- UI Functions ---
        const openModal = (modalId) => document.getElementById(modalId).classList.add('active');
        const closeModal = (modalId) => document.getElementById(modalId).classList.remove('active');

        const updateNav = () => {
            if (isLoggedIn) {
                document.getElementById('logged-out-nav').classList.add('hidden');
                document.getElementById('logged-in-nav').classList.remove('hidden');
            } else {
                document.getElementById('logged-out-nav').classList.remove('hidden');
                document.getElementById('logged-in-nav').classList.add('hidden');
            }
        };

        const login = () => {
            isLoggedIn = true;
            updateNav();
            closeModal('loginModal');
            closeModal('registerModal');
        };

        const logout = () => {
            isLoggedIn = false;
            updateNav();
        };

        // --- Map & Stats Loading ---
        const loadMap = async () => {
            const map = L.map('map').setView([29.4241, -98.4936], 10); // Center on San Antonio, TX
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            try {
                const response = await fetch('/api/watches');
                if (!response.ok) throw new Error('Failed to fetch watch locations');
                
                const watches = await response.json();
                
                const lostIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
                const foundIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });

                watches.forEach(watch => {
                    if (watch.latitude && watch.longitude) {
                        const icon = watch.status === 'lost' ? lostIcon : foundIcon;
                        L.marker([watch.latitude, watch.longitude], { icon })
                         .addTo(map)
                         .bindPopup(`<b>Apple Watch ${watch.model}</b><br>Status: ${watch.status}<br>Reported: ${new Date(watch.reported_at).toLocaleDateString()}`);
                    }
                });
            } catch (error) {
                console.error("Error loading map data:", error);
            }
        };

        const loadStats = async () => {
            try {
                const response = await fetch('/api/stats');
                if (!response.ok) throw new Error('Failed to fetch stats');
                const stats = await response.json();

                document.getElementById('lost-count').innerText = stats.lost || 0;
                document.getElementById('found-count').innerText = stats.found || 0;
                document.getElementById('reunited-count').innerText = stats.reunited || 0;

            } catch(error) {
                console.error("Error loading stats:", error);
                document.getElementById('lost-count').innerText = 'N/A';
                document.getElementById('found-count').innerText = 'N/A';
                document.getElementById('reunited-count').innerText = 'N/A';
            }
        };

        // --- Form Handlers ---
        const handleReportSubmit = async (event, status) => {
            event.preventDefault();
            
            const serialNumber = document.getElementById(`${status}Serial`).value;
            const model = document.getElementById(`${status}Model`).value;
            const color = document.getElementById(`${status}Color`).value;

            if (!serialNumber || !model || !color) {
                alert('Please fill out all watch details.');
                return;
            }

            // In a real app, you would use a geocoding service to convert the address to lat/lng.
            // For now, we'll generate random coordinates near San Antonio for demonstration.
            const latitude = 29.4241 + (Math.random() - 0.5) * 0.2;
            const longitude = -98.4936 + (Math.random() - 0.5) * 0.2;

            const watchData = { serial_number: serialNumber, model, color, status, latitude, longitude };

            try {
                const response = await fetch('/api/watches', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(watchData)
                });

                if (!response.ok) {
                    throw new Error('Failed to submit report.');
                }

                alert(`Thank you! Your ${status} watch report has been submitted.`);
                closeModal(`${status}Modal`);
                location.reload(); // Refresh to update the map and stats
            } catch (error) {
                console.error(`Error submitting ${status} report:`, error);
                alert(`There was an error submitting your report. Please try again.`);
            }
        };


        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            updateNav();
            loadMap();
            loadStats();

            document.getElementById('loginForm').addEventListener('submit', (e) => {
                e.preventDefault();
                // Placeholder for real authentication
                login();
            });
            document.getElementById('registerForm').addEventListener('submit', (e) => {
                e.preventDefault();
                // Placeholder for real registration
                login();
            });
            document.getElementById('foundForm').addEventListener('submit', (e) => handleReportSubmit(e, 'found'));
            document.getElementById('lostForm').addEventListener('submit', (e) => handleReportSubmit(e, 'lost'));
        });
    </script>
</body>
</html>

